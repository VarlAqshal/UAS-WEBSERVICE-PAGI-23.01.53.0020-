<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sistem Kasir Web Service - Final</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .hidden { display: none; }
        .card-produk { transition: 0.3s; }
        .card-produk:hover { transform: translateY(-5px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-light">
<div class="container mt-4">
    <h2 class="text-center mb-4">üõí KASIR DIGITAL</h2>
    
    <div id="login-section" class="card p-4 mx-auto shadow" style="max-width: 400px;">
        <h4>Login Kasir</h4>
        <input type="text" id="username" class="form-control mb-2" placeholder="Username">
        <input type="password" id="password" class="form-control mb-3" placeholder="Password">
        <button onclick="login()" class="btn btn-primary w-100">Masuk</button>
    </div>

    <div id="main-app" class="hidden">
        <div class="d-flex justify-content-between align-items-center mb-3 bg-white p-3 rounded shadow-sm">
            <span id="nama-kasir" class="badge bg-info p-2 text-dark" style="font-size: 1rem;"></span>
            <button onclick="logout()" class="btn btn-danger btn-sm">Logout</button>
        </div>
        
        <div class="row">
            <div class="col-md-7">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h4>Daftar Produk</h4>
                    <button onclick="fetchProduk()" class="btn btn-outline-secondary btn-sm">Refresh Stok</button>
                </div>
                <div id="produk-list" class="row"></div>
            </div>

            <div class="col-md-5">
                <h4>Keranjang Belanja</h4>
                <ul id="cart-list" class="list-group mb-3 shadow-sm" style="max-height: 300px; overflow-y: auto;">
                    </ul>
                <div class="card p-3 shadow border-0">
                    <h5 class="d-flex justify-content-between">Total: <span>Rp <span id="total-harga">0</span></span></h5>
                    <button onclick="checkout()" class="btn btn-success w-100 mt-2 py-2 fw-bold">PROSES BAYAR</button>
                </div>
            </div>
        </div>

        <div class="mt-5 mb-5">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h4>üìã Riwayat Transaksi</h4>
                <button onclick="fetchHistory()" class="btn btn-outline-secondary btn-sm">Update Riwayat</button>
            </div>
            <div class="table-responsive">
                <table class="table table-hover table-bordered bg-white shadow-sm">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Waktu</th>
                            <th>Kasir</th>
                            <th>Total Belanja</th>
                        </tr>
                    </thead>
                    <tbody id="history-list"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEdit" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">Edit Data Produk</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-id">
                <div class="mb-3">
                    <label class="form-label">Nama Produk</label>
                    <input type="text" id="edit-nama" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Harga (Rp)</label>
                    <input type="number" id="edit-harga" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Stok Baru</label>
                    <input type="number" id="edit-stok" class="form-control" placeholder="Masukkan jumlah stok">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button onclick="saveUpdate()" class="btn btn-warning">Simpan Perubahan</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let cart = [], total = 0, currentUser = null;

    // --- FITUR AUTO LOGIN (Cek Session) ---
    window.onload = function() {
        let savedUser = localStorage.getItem('pos_user');
        if (savedUser) {
            currentUser = JSON.parse(savedUser);
            showApp();
        }
    }

    async function login() {
        let fd = new FormData();
        fd.append('username', document.getElementById('username').value);
        fd.append('password', document.getElementById('password').value);
        
        let res = await fetch('login.php', {method: 'POST', body: fd});
        let result = await res.json();
        
        if (result.status == 'success') {
            currentUser = result.data;
            localStorage.setItem('pos_user', JSON.stringify(currentUser)); // Simpan session
            showApp();
        } else { 
            alert("Login Gagal: Username atau Password salah"); 
        }
    }

    function showApp() {
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        document.getElementById('nama-kasir').innerText = "Kasir: " + currentUser.nama;
        fetchProduk(); 
        fetchHistory();
    }

    function logout() {
        localStorage.removeItem('pos_user');
        location.reload();
    }

    // --- FUNGSI PRODUK ---
    async function fetchProduk() {
        let res = await fetch('get_produk.php');
        let result = await res.json();
        let cont = document.getElementById('produk-list');
        cont.innerHTML = '';
        
        result.data.forEach(p => {
            cont.innerHTML += `
                <div class="col-md-6 mb-3">
                    <div class="card p-3 shadow-sm card-produk">
                        <h6 class="mb-1">${p.nama_produk}</h6>
                        <p class="small text-muted mb-2">Stok: <b>${p.stok}</b> | Rp ${p.harga}</p>
                        <div class="d-flex gap-1">
                            <button class="btn btn-primary btn-sm flex-grow-1" onclick="addToCart(${p.id_produk},'${p.nama_produk}',${p.harga})">Tambah</button>
                            <button class="btn btn-outline-warning btn-sm" onclick='showEdit(${JSON.stringify(p)})'>‚úèÔ∏è</button>
                        </div>
                    </div>
                </div>`;
        });
    }

    function addToCart(id, n, h) {
        cart.push({id_produk: id, nama: n, harga: h, jumlah: 1, subtotal: h});
        updateCart();
    }

    function updateCart() {
        let list = document.getElementById('cart-list');
        list.innerHTML = ''; 
        total = 0;
        
        cart.forEach((i, index) => {
            list.innerHTML += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-danger" style="cursor:pointer" onclick="removeFromCart(${index})">‚úï </small>
                        ${i.nama}
                    </div>
                    <span>Rp ${i.harga}</span>
                </li>`;
            total += i.harga;
        });
        document.getElementById('total-harga').innerText = total;
    }

    function removeFromCart(index) {
        cart.splice(index, 1);
        updateCart();
    }

    // --- FUNGSI TRANSAKSI ---
    async function checkout() {
        if (cart.length == 0) return alert("Keranjang masih kosong!");
        
        let res = await fetch('transaksi.php', {
            method: 'POST', 
            body: JSON.stringify({id_user: currentUser.id_user, total_harga: total, items: cart}),
            headers: { 'Content-Type': 'application/json' }
        });
        
        let result = await res.json();
        if (result.status == 'success') { 
            alert("Transaksi Berhasil disimpan!"); 
            cart = []; 
            updateCart(); 
            fetchProduk(); // Update stok di layar
            fetchHistory(); // Update tabel riwayat di layar
        }
    }

    // --- FUNGSI RIWAYAT ---
    async function fetchHistory() {
        let res = await fetch('get_riwayat.php');
        let result = await res.json();
        let list = document.getElementById('history-list');
        list.innerHTML = '';
        
        result.data.forEach(h => {
            list.innerHTML += `
                <tr>
                    <td>#${h.id_transaksi}</td>
                    <td>${h.tgl_transaksi}</td>
                    <td><span class="badge bg-secondary">${h.nama_lengkap}</span></td>
                    <td><b>Rp ${h.total_harga}</b></td>
                </tr>`;
        });
    }

    // --- FUNGSI UPDATE PRODUK ---
    function showEdit(p) {
        document.getElementById('edit-id').value = p.id_produk;
        document.getElementById('edit-nama').value = p.nama_produk;
        document.getElementById('edit-harga').value = p.harga;
        document.getElementById('edit-stok').value = p.stok;
        
        let myModal = new bootstrap.Modal(document.getElementById('modalEdit'));
        myModal.show();
    }

    async function saveUpdate() {
        let fd = new FormData();
        fd.append('id_produk', document.getElementById('edit-id').value);
        fd.append('nama_produk', document.getElementById('edit-nama').value);
        fd.append('harga', document.getElementById('edit-harga').value);
        fd.append('stok', document.getElementById('edit-stok').value);
        
        let res = await fetch('update_produk.php', {method: 'POST', body: fd});
        let result = await res.json();
        
        if (result.status == 'success') {
            alert("Data produk diperbarui!");
            // Tutup Modal
            let modalElement = document.getElementById('modalEdit');
            let modalInstance = bootstrap.Modal.getInstance(modalElement);
            modalInstance.hide();
            
            fetchProduk(); // Refresh daftar produk di layar tanpa logout
        }
    }
</script>
</body>
</html>